<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sensor Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #f5f5f5;
            }
            .sensor-box {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                margin: 10px 0;
            }
            .sensor-title {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 10px;
            }
            .data-row {
                margin: 5px 0;
                font-family: monospace;
            }
            .status {
                color: #666;
                font-style: italic;
            }
            .working {
                color: green;
            }
            .not-working {
                color: red;
            }
        </style>
    </head>
    <body>
        <h1>üî¨ Sensor Test</h1>
        <p>–¢–µ—Å—Ç –¥–∞—Ç—á–∏–∫–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</p>

        <div class="sensor-box">
            <div class="sensor-title">–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</div>
            <p>–î–ª—è iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—Ç—á–∏–∫–∞–º –¥–≤–∏–∂–µ–Ω–∏—è –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏.</p>
            <button id="requestPermissions" onclick="requestAllPermissions()">
                –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            </button>
            <div id="permissionStatus" class="status"></div>
        </div>

        <div id="motionSensor" class="sensor-box">
            <div class="sensor-title">Motion Sensor (–ê–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä)</div>
            <div class="status" id="motionStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏...</div>
            <div id="motionData"></div>
            <button id="testMotion" onclick="testMotionSensor()">
                –¢–µ—Å—Ç Motion
            </button>
        </div>

        <div id="orientationSensor" class="sensor-box">
            <div class="sensor-title">Orientation Sensor (–ì–∏—Ä–æ—Å–∫–æ–ø)</div>
            <div class="status" id="orientationStatus">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏...
            </div>
            <div id="orientationData"></div>
            <button id="testOrientation" onclick="testOrientationSensor()">
                –¢–µ—Å—Ç Orientation
            </button>
        </div>

        <div id="touchSensor" class="sensor-box">
            <div class="sensor-title">Touch Sensor (–¢–∞—á)</div>
            <div class="status" id="touchStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏...</div>
            <div id="touchData"></div>
            <button id="testTouch" onclick="testTouchSensor()">
                –¢–µ—Å—Ç Touch
            </button>
        </div>

        <script>
            // Motion Sensor
            class MotionSensor {
                constructor() {
                    this.data = {
                        acceleration: { x: 0, y: 0, z: 0 },
                        rotation: { alpha: 0, beta: 0, gamma: 0 },
                        motionDetected: false,
                        isValid: false,
                    };
                    this.listeners = [];
                    this.motionThreshold = 1.0;
                    this.init();
                }

                init() {
                    if (this.isSupported()) {
                        window.addEventListener(
                            "devicemotion",
                            this.handleMotion.bind(this),
                        );
                    }
                }

                handleMotion(event) {
                    const acceleration = event.acceleration || {
                        x: 0,
                        y: 0,
                        z: 0,
                    };
                    const rotationRate = event.rotationRate || {
                        alpha: 0,
                        beta: 0,
                        gamma: 0,
                    };

                    const totalAcceleration = Math.abs(
                        (acceleration.x || 0) +
                            (acceleration.y || 0) +
                            (acceleration.z || 0),
                    );

                    this.data = {
                        acceleration: {
                            x: parseFloat((acceleration.x || 0).toFixed(2)),
                            y: parseFloat((acceleration.y || 0).toFixed(2)),
                            z: parseFloat((acceleration.z || 0).toFixed(2)),
                        },
                        rotation: {
                            alpha: parseFloat(
                                (rotationRate.alpha || 0).toFixed(2),
                            ),
                            beta: parseFloat(
                                (rotationRate.beta || 0).toFixed(2),
                            ),
                            gamma: parseFloat(
                                (rotationRate.gamma || 0).toFixed(2),
                            ),
                        },
                        motionDetected:
                            totalAcceleration > this.motionThreshold,
                        isValid: true,
                    };

                    this.notifyListeners();
                }

                notifyListeners() {
                    this.listeners.forEach((callback) => callback(this.data));
                }

                subscribe(callback) {
                    this.listeners.push(callback);
                }

                isSupported() {
                    return "DeviceMotionEvent" in window;
                }

                async test() {
                    if (!this.isSupported()) return false;

                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => resolve(false), 3000);

                        const testHandler = (event) => {
                            if (event.acceleration || event.rotationRate) {
                                clearTimeout(timeout);
                                window.removeEventListener(
                                    "devicemotion",
                                    testHandler,
                                );
                                resolve(true);
                            }
                        };

                        window.addEventListener("devicemotion", testHandler);
                    });
                }
            }

            // Orientation Sensor
            class OrientationSensor {
                constructor() {
                    this.data = {
                        alpha: 0,
                        beta: 0,
                        gamma: 0,
                        isValid: false,
                    };
                    this.listeners = [];
                    this.init();
                }

                init() {
                    if (this.isSupported()) {
                        window.addEventListener(
                            "deviceorientation",
                            this.handleOrientation.bind(this),
                        );
                    }
                }

                handleOrientation(event) {
                    if (
                        event.alpha !== null &&
                        event.beta !== null &&
                        event.gamma !== null
                    ) {
                        this.data = {
                            alpha: parseFloat(event.alpha.toFixed(2)),
                            beta: parseFloat(event.beta.toFixed(2)),
                            gamma: parseFloat(event.gamma.toFixed(2)),
                            isValid: true,
                        };

                        this.notifyListeners();
                    }
                }

                notifyListeners() {
                    this.listeners.forEach((callback) => callback(this.data));
                }

                subscribe(callback) {
                    this.listeners.push(callback);
                }

                isSupported() {
                    return "DeviceOrientationEvent" in window;
                }

                async test() {
                    if (!this.isSupported()) return false;

                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => resolve(false), 3000);

                        const testHandler = (event) => {
                            if (event.alpha !== null) {
                                clearTimeout(timeout);
                                window.removeEventListener(
                                    "deviceorientation",
                                    testHandler,
                                );
                                resolve(true);
                            }
                        };

                        window.addEventListener(
                            "deviceorientation",
                            testHandler,
                        );
                    });
                }
            }

            // Touch Sensor
            class TouchSensor {
                constructor() {
                    this.data = {
                        touchCount: 0,
                        touches: [],
                        multiTouchDetected: false,
                        gestureType: "none",
                        isValid: false,
                    };
                    this.listeners = [];
                    this.init();
                }

                init() {
                    if (this.isSupported()) {
                        document.addEventListener(
                            "touchstart",
                            this.handleTouchStart.bind(this),
                        );
                        document.addEventListener(
                            "touchmove",
                            this.handleTouchMove.bind(this),
                        );
                        document.addEventListener(
                            "touchend",
                            this.handleTouchEnd.bind(this),
                        );
                    }
                }

                handleTouchStart(event) {
                    this.processTouchEvent(event);
                }

                handleTouchMove(event) {
                    this.processTouchEvent(event);
                }

                handleTouchEnd(event) {
                    this.processTouchEvent(event);
                    this.data.gestureType =
                        event.touches.length > 0 ? "single" : "none";
                }

                processTouchEvent(event) {
                    const touches = Array.from(event.touches).map((touch) => ({
                        x: touch.clientX,
                        y: touch.clientY,
                        force: touch.force || 0.5,
                    }));

                    this.data = {
                        touchCount: event.touches.length,
                        touches: touches,
                        multiTouchDetected: touches.length > 1,
                        gestureType:
                            touches.length === 1
                                ? "single"
                                : this.data.gestureType,
                        isValid: true,
                    };

                    this.notifyListeners();
                }

                notifyListeners() {
                    this.listeners.forEach((callback) => callback(this.data));
                }

                subscribe(callback) {
                    this.listeners.push(callback);
                }

                isSupported() {
                    return (
                        "ontouchstart" in window || navigator.maxTouchPoints > 0
                    );
                }

                async test() {
                    if (!this.isSupported()) return false;

                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => resolve(false), 5000);

                        const testHandler = () => {
                            clearTimeout(timeout);
                            document.removeEventListener(
                                "touchstart",
                                testHandler,
                            );
                            resolve(true);
                        };

                        document.addEventListener("touchstart", testHandler);
                    });
                }

                getSupportInfo() {
                    return {
                        touchSupported: this.isSupported(),
                        maxTouchPoints: navigator.maxTouchPoints || 0,
                    };
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            async function requestPermissions() {
                const results = {
                    motion: false,
                    orientation: false
                };

                // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è DeviceMotionEvent
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceMotionEvent.requestPermission();
                        results.motion = permission === 'granted';
                    } catch (error) {
                        console.log('DeviceMotionEvent permission error:', error);
                        results.motion = false;
                    }
                } else {
                    // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –≥–¥–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                    results.motion = true;
                }

                // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è DeviceOrientationEvent
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        results.orientation = permission === 'granted';
                    } catch (error) {
                        console.log('DeviceOrientationEvent permission error:', error);
                        results.orientation = false;
                    }
                } else {
                    // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –≥–¥–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                    results.orientation = true;
                }

                return results;
            }

            // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–µ–Ω—Å–æ—Ä–æ–≤
            const motionSensor = new MotionSensor();
            const orientationSensor = new OrientationSensor();
            const touchSensor = new TouchSensor();

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
            async function requestAllPermissions() {
                const btn = document.getElementById("requestPermissions");
                const status = document.getElementById("permissionStatus");
                
                btn.disabled = true;
                btn.textContent = "–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...";
                status.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...";
                status.className = "status";

                const permissions = await requestPermissions();
                
                btn.disabled = false;
                btn.textContent = "–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è";
                
                const motionText = permissions.motion ? "‚úì Motion" : "‚úó Motion";
                const orientationText = permissions.orientation ? "‚úì Orientation" : "‚úó Orientation";
                
                status.innerHTML = `${motionText}, ${orientationText}`;
                status.className = `status ${(permissions.motion && permissions.orientation) ? "working" : "not-working"}`;
            }

            async function testMotionSensor() {
                const btn = document.getElementById("testMotion");
                btn.disabled = true;
                btn.textContent = "–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π...";

                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                const permissions = await requestPermissions();
                
                if (!permissions.motion) {
                    btn.disabled = false;
                    btn.textContent = "‚úó –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ";
                    btn.className = "not-working";
                    return;
                }

                btn.textContent = "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...";
                const result = await motionSensor.test();

                btn.disabled = false;
                btn.textContent = result ? "‚úì –†–∞–±–æ—Ç–∞–µ—Ç" : "‚úó –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç";
                btn.className = result ? "working" : "not-working";
            }

            async function testOrientationSensor() {
                const btn = document.getElementById("testOrientation");
                btn.disabled = true;
                btn.textContent = "–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π...";

                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                const permissions = await requestPermissions();
                
                if (!permissions.orientation) {
                    btn.disabled = false;
                    btn.textContent = "‚úó –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ";
                    btn.className = "not-working";
                    return;
                }

                btn.textContent = "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...";
                const result = await orientationSensor.test();

                btn.disabled = false;
                btn.textContent = result ? "‚úì –†–∞–±–æ—Ç–∞–µ—Ç" : "‚úó –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç";
                btn.className = result ? "working" : "not-working";
            }

            async function testTouchSensor() {
                const btn = document.getElementById("testTouch");
                btn.disabled = true;
                btn.textContent = "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...";

                const result = await touchSensor.test();

                btn.disabled = false;
                btn.textContent = result ? "‚úì –†–∞–±–æ—Ç–∞–µ—Ç" : "‚úó –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç";
                btn.className = result ? "working" : "not-working";
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            function init() {
                // Motion Sensor
                const motionStatus = document.getElementById("motionStatus");
                const motionData = document.getElementById("motionData");

                if (motionSensor.isSupported()) {
                    motionStatus.textContent = "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                    motionStatus.className = "status working";

                    motionSensor.subscribe((data) => {
                        if (data.isValid) {
                            motionData.innerHTML = `
                            <div class="data-row">Acceleration: X=${data.acceleration.x}, Y=${data.acceleration.y}, Z=${data.acceleration.z}</div>
                            <div class="data-row">Rotation: Œ±=${data.rotation.alpha}, Œ≤=${data.rotation.beta}, Œ≥=${data.rotation.gamma}</div>
                            <div class="data-row">Motion: ${data.motionDetected ? "–î–ê" : "–ù–ï–¢"}</div>
                        `;
                        }
                    });
                } else {
                    motionStatus.textContent = "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                    motionStatus.className = "status not-working";
                }

                // Orientation Sensor
                const orientationStatus =
                    document.getElementById("orientationStatus");
                const orientationData =
                    document.getElementById("orientationData");

                if (orientationSensor.isSupported()) {
                    orientationStatus.textContent = "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                    orientationStatus.className = "status working";

                    orientationSensor.subscribe((data) => {
                        if (data.isValid) {
                            orientationData.innerHTML = `
                            <div class="data-row">Alpha (Z): ${data.alpha}¬∞</div>
                            <div class="data-row">Beta (X): ${data.beta}¬∞</div>
                            <div class="data-row">Gamma (Y): ${data.gamma}¬∞</div>
                        `;
                        }
                    });
                } else {
                    orientationStatus.textContent = "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                    orientationStatus.className = "status not-working";
                }

                // Touch Sensor
                const touchStatus = document.getElementById("touchStatus");
                const touchData = document.getElementById("touchData");

                if (touchSensor.isSupported()) {
                    const info = touchSensor.getSupportInfo();
                    touchStatus.textContent = `–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (${info.maxTouchPoints} —Ç–æ—á–µ–∫)`;
                    touchStatus.className = "status working";

                    touchSensor.subscribe((data) => {
                        if (data.isValid) {
                            touchData.innerHTML = `
                            <div class="data-row">–ö–∞—Å–∞–Ω–∏—è: ${data.touchCount}</div>
                            <div class="data-row">–ú—É–ª—å—Ç–∏-—Ç–∞—á: ${data.multiTouchDetected ? "–î–ê" : "–ù–ï–¢"}</div>
                            <div class="data-row">–ñ–µ—Å—Ç: ${data.gestureType}</div>
                        `;
                        }
                    });
                } else {
                    touchStatus.textContent = "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                    touchStatus.className = "status not-working";
                }
            }

            // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
